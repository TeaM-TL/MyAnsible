global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot          /var/lib/haproxy
    stats socket    /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout   30s
    user            haproxy
    group           haproxy
    daemon

    # Default SSL material locations
    #ca-base /etc/ssl/certs
    #crt-base /etc/ssl/private

    # See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-dh-param-file /etc/haproxy/dhparams.pem

# ------------------------------------------------------
defaults
    log                 global
    option              dontlognull
    balance             roundrobin
    timeout connect     900s
    timeout client      900s
    timeout server      900s
    errorfile 400       /etc/haproxy/errors/400.http
    errorfile 403       /etc/haproxy/errors/403.http
    errorfile 408       /etc/haproxy/errors/408.http
    errorfile 500       /etc/haproxy/errors/500.http
    errorfile 502       /etc/haproxy/errors/502.http
    errorfile 503       /etc/haproxy/errors/503.http
    errorfile 504       /etc/haproxy/errors/504.http
    mode                tcp

# ======================================================
# - STATS
# ------------------------------------------------------
frontend                stats
    bind                *:8404
    mode                http
    stats               enable
    stats uri           /stats
    stats refresh       300s
    #stats               hide-version
    stats               show-node

# ======================================================
# - LDAP
# ------------------------------------------------------
# - frontend -------------------------------------------
frontend                ldap
    bind                *:389
    option              tcplog
    default_backend     ldap_servers

frontend                ldaps
    bind                *:636 ssl crt /etc/ssl/{{ansible_hostname}}.pem
    option              tcplog
    default_backend     ldap_servers

# - backend -------------------------------------------
backend                 ldap_servers
    option              ldap-check
    server              ldap1 ldap167.{{ domain_name }}:389 check
    server              ldap2 ldap177.{{ domain_name }}:389 check

#backend                 ldaps_servers
#    option              ssl-hello-chk
#    server              ldaps1 ldap167.{{ domain_name }}:636 ssl verify required ca-file /etc/ssl/certs/ca.pem check
#    server              ldaps2 ldap177.{{ domain_name }}:636 ssl verify required ca-file /etc/ssl/certs/ca.pem check

# ======================================================
# - WWW
# ------------------------------------------------------
# - frontend -------------------------------------------
frontend                http
    bind                *:80
    bind                *:443 ssl crt /etc/ssl/{{ansible_hostname}}.pem
    mode                http
    option              httplog
    option              forwardfor
    acl                 aci_url_egw         path_beg /e
    use_backend         http_servers_egw    if aci_url_egw
    default_backend     http_servers

# - backend --------------------------------------------
backend                 http_servers
    mode                http
    option httpchk      HEAD / HTTP/1.0
    server              http1 ldap167.{{ domain_name }}:80 check
    server              http2 ldap177.{{ domain_name }}:80 check

backend                 http_servers_egw
    mode                http
    option httpchk      HEAD / HTTP/1.0
    server              http1 lamp166.{{ domain_name }}:80 check
    server              http2 lamp176.{{ domain_name }}:80 check

# ======================================================
# - MariaDB
# ------------------------------------------------------
# - frontend -------------------------------------------
frontend                mariadb
    bind                *:3306
    option              tcplog
    default_backend     mariadb_servers

# - backend --------------------------------------------
backend                 mariadb_servers
    option mysql-check  user haproxy
    server              mariadb1 lamp166.{{ domain_name }}:3306 check
    server              mariadb2 lamp176.{{ domain_name }}:3306 check

# ======================================================
# - Zabbix
# ------------------------------------------------------
# - frontend -------------------------------------------
frontend                zabbix
    bind                *:10051
    option              tcplog
    default_backend     zabbix_servers

# - backend --------------------------------------------
backend zabbix_servers
    server              zabbix1 ldap167.{{ domain_name }}:10051 check
    server              zabbix2 ldap177.{{ domain_name }}:10051 check

